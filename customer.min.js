import{saveJob,loadPendingJobs}from"./customer-firebase.js";window.addEventListener("DOMContentLoaded",async()=>{const e=document.getElementById("loader");try{e.classList.remove("hidden");const t=await loadPendingJobs();t.sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)),t.forEach(e=>{activeJobs[e.id]=e,addJobCard(e)}),console.log(`✅ Loaded ${t.length} pending jobs from Firestore`)}catch(e){console.error("❌ Error loading jobs:",e)}finally{e.classList.add("hidden")}});const addBtn=document.getElementById("addBtn"),addFormSection=document.getElementById("addForm"),customerForm=document.getElementById("customerForm"),cancelBtn=document.getElementById("cancelBtn"),services=Array.from(document.querySelectorAll(".service")),totalEl=document.getElementById("total"),cardsContainer=document.getElementById("cardsContainer"),modal=document.getElementById("receiptModal"),closeReceipt=document.getElementById("closeReceipt"),r_plate=document.getElementById("r_plate"),r_model=document.getElementById("r_model"),r_color=document.getElementById("r_color"),r_phone=document.getElementById("r_phone"),r_services=document.getElementById("r_services"),r_payment=document.getElementById("r_payment"),r_total=document.getElementById("r_total"),markFinishedBtn=document.getElementById("markFinished");let activeJobs={};function closeForm(){addBtn.setAttribute("aria-expanded","false"),addFormSection.setAttribute("aria-hidden","true")}function resetForm(){customerForm.reset(),services.forEach(e=>{e.setAttribute("aria-pressed","false"),e.classList.remove("active")}),updateTotal()}function updateTotal(){const e=services.filter(e=>"true"===e.getAttribute("aria-pressed")).reduce((e,t)=>e+Number(t.dataset.price||0),0);return totalEl.textContent=`Kshs ${e}`,e}function addJobCard(e){const t=document.createElement("button");t.className="card",t.type="button",t.dataset.jobId=e.id,t.innerHTML=`\n    <div class="left">\n      <div class="plate">${e.plate}</div>\n      <div class="meta">${e.services.length} service(s) • ${e.model} • ${e.color}</div>\n    </div>\n    <div class="right">\n      <div class="tag">${e.status}</div>\n    </div>\n  `,t.addEventListener("click",()=>openReceipt(e.id)),cardsContainer.prepend(t)}function openReceipt(e){const t=activeJobs[e];if(t){if(r_plate.textContent=t.plate,r_model.textContent=t.model,r_color.textContent=t.color,r_phone.textContent=t.phone,r_payment.textContent="mpesa"===t.payment?"M-Pesa":"Cash",r_total.textContent=`Kshs ${t.total}`,r_services.innerHTML="",0===t.services.length){const e=document.createElement("li");e.textContent="No services selected",r_services.appendChild(e)}else t.services.forEach(e=>{const t=document.createElement("li");t.textContent=`${e.name} — Kshs ${e.price}`,r_services.appendChild(t)});modal.dataset.jobId=e,modal.setAttribute("aria-hidden","false"),modal.style.display="flex",setTimeout(()=>closeReceipt.focus(),80)}}function closeModal(){modal.setAttribute("aria-hidden","true"),modal.style.display="none",delete modal.dataset.jobId}addBtn.addEventListener("click",()=>{const e="true"===addBtn.getAttribute("aria-expanded");addBtn.setAttribute("aria-expanded",String(!e)),addFormSection.setAttribute("aria-hidden",String(e)),e||setTimeout(()=>document.getElementById("plate").focus(),120)}),cancelBtn.addEventListener("click",()=>{resetForm(),closeForm()}),services.forEach(e=>{e.addEventListener("click",()=>{const t="true"===e.getAttribute("aria-pressed");e.setAttribute("aria-pressed",String(!t)),e.classList.toggle("active",!t),updateTotal()}),e.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),e.click())})}),customerForm.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("plate").value.trim(),n=document.getElementById("model").value.trim(),o=document.getElementById("color").value.trim(),d=document.getElementById("phone").value.trim()||"—",a=document.querySelector('input[name="payment"]:checked').value,r=services.filter(e=>"true"===e.getAttribute("aria-pressed")).map(e=>({name:e.querySelector(".service-name").textContent,price:Number(e.dataset.price)})),s=updateTotal();if(!t||!n||!o)return void alert("Please fill the required fields: number plate, model and color.");const c=`job_${Date.now()}`,l={id:c,plate:t,model:n,color:o,phone:d,payment:a,services:r,total:s,status:"Pending",createdAt:(new Date).toISOString()};try{const e=await saveJob(l);localStorage.setItem("lastJobId",c),e&&(console.log("✅ Job saved successfully:",e),l.firestoreId=e,activeJobs[c]=l,addJobCard(l))}catch(e){console.error("❌ Failed to save job:",e)}resetForm(),closeForm()}),closeReceipt.addEventListener("click",closeModal),modal.addEventListener("click",e=>{e.target===modal&&closeModal()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&"false"===modal.getAttribute("aria-hidden")&&closeModal()}),markFinishedBtn.addEventListener("click",()=>{const e=modal.dataset.jobId;if(!e)return;const t=activeJobs[e];if(!t)return;t.status="Finished",t.finishedAt=(new Date).toISOString();const n=document.querySelector(`.card[data-job-id="${e}"]`);if(n){const e=n.querySelector(".tag");e&&(e.textContent="Finished",e.style.background="transparent",e.style.color="rgba(255,255,255,0.85)",e.style.border="1px solid rgba(255,255,255,0.06)")}closeModal()});